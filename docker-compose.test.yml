services:
  directus:
    image: directus/directus:${DIRECTUS_VERSION:-11.15.1}
    container_name: directus-push-notification-${TEST_SUITE_ID:-main}-${DIRECTUS_VERSION:-latest}
    environment:
      DB_CLIENT: "sqlite3"
      DB_FILENAME: "/tmp/data/directus.db"
      # ⚠️ TEST ENVIRONMENT ONLY - Deterministic keys for CI/CD reproducibility
      # These credentials are ONLY for automated testing, NOT for production use
      KEY: "test-key-for-ci-only"
      SECRET: "test-secret-for-ci-only-abcdef1234567890abcdef1234567890"
      ADMIN_EMAIL: "admin@example.com"
      ADMIN_PASSWORD: "test-password-ci-only"
      PUBLIC_URL: "https://directus:8055"
      STORAGE_LOCAL_ROOT: "/directus/uploads"
      EXTENSIONS_PATH: "./extensions"
      EXTENSIONS_AUTO_RELOAD: "true"
      PERMISSIONS_CACHE_TTL: "0"
      CACHE_ENABLED: "false"
      ACCEPT_TERMS: "true"
      PROJECT_OWNER: "admin@example.com"

      # ⚠️ TEST VAPID KEYS - DO NOT USE IN REAL ENVIRONMENTS
      # These keys are for automated testing only
      VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY:-BPT864f6ph9vkIXmyWJFsehe-Bb9iul4IiNoRN3To0UrixxFKKKsKGM4FUBF_vtjSAoFWxBDY9-4pdCCIMJwz7o}"
      VAPID_PRIVATE_KEY: "${VAPID_PRIVATE_KEY:-xJQ5l1xcpN79nKn5x1ufvuo0kGIuWGF5bPQDuiJKwlk}"

      # Melhorar performance de inicialização
      LOG_LEVEL: "warn"
      DB_POOL_MIN: "0"
      DB_POOL_MAX: "5"
    volumes:
      - ./dist/app.js:/directus/extensions/directus-extension-push-notification/dist/app.js:ro
      - ./dist/api.js:/directus/extensions/directus-extension-push-notification/dist/api.js:ro
      - ./package.json:/directus/extensions/directus-extension-push-notification/package.json:ro
      - ./dist/directus-state.json:/directus/extensions/directus-extension-push-notification/dist/directus-state.json:ro
      - ./dist/service-worker.js:/directus/extensions/directus-extension-push-notification/dist/service-worker.js:ro
    tmpfs:
      - /directus/uploads:rw,noexec,nosuid,size=64M,mode=777
      - /tmp/data:rw,size=64M,mode=777
    networks:
      - directus-test-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://0.0.0.0:8055/server/health",
        ]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 120s

  tests:
    image: mcr.microsoft.com/playwright:v1.57.0
    container_name: directus-push-notification-tests-${TEST_SUITE_ID:-main}-${DIRECTUS_VERSION:-latest}
    environment:
      - CI=true
      - DIRECTUS_URL=http://directus:8055
    depends_on:
      directus:
        condition: service_healthy
    working_dir: /workspace
    volumes:
      - ./:/workspace:rw
      - /dev/shm:/dev/shm
    networks:
      - directus-test-network
    command:
      - bash
      - -lc
      - |
        npm i -g pnpm@10.29.2 && \
        pnpm install --frozen-lockfile && \
        pnpm exec playwright install --with-deps && \
        pnpm test:e2e

networks:
  directus-test-network:
    name: directus-test-network-${TEST_SUITE_ID:-main}
    driver: bridge
