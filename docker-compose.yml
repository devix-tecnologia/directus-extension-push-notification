services:
  directus:
    image: directus/directus:11.15.1
    container_name: directus-push-notification-dev
    environment:
      # SQLite em memória para desenvolvimento rápido
      DB_CLIENT: "sqlite3"
      DB_FILENAME: "/tmp/data/directus.db"

      # ⚠️⚠️⚠️ DEVELOPMENT ONLY - DO NOT USE IN PRODUCTION ⚠️⚠️⚠️
      # These credentials are intentionally simple for local development.
      # In production, ALWAYS generate secure random values:
      #   KEY: openssl rand -hex 16
      #   SECRET: openssl rand -base64 32
      KEY: "${DIRECTUS_KEY:-dev-key}"
      SECRET: "${DIRECTUS_SECRET:-dev-secret-abcdef1234567890abcdef1234567890}"

      ADMIN_EMAIL: "${ADMIN_EMAIL:-admin@example.com}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-admin123}"

      PUBLIC_URL: "http://localhost:8055"

      STORAGE_LOCAL_ROOT: "/directus/uploads"
      EXTENSIONS_PATH: "./extensions"
      EXTENSIONS_AUTO_RELOAD: "true"

      PERMISSIONS_CACHE_TTL: "0"
      CACHE_ENABLED: "false"

      ACCEPT_TERMS: "true"
      PROJECT_OWNER: "admin@example.com"

      # ⚠️⚠️⚠️ NEVER REUSE THESE EXAMPLE VAPID KEYS IN PRODUCTION ⚠️⚠️⚠️
      # These keys are PUBLIC and shared in documentation.
      # Using them in production means ANYONE can send fake notifications to your users!
      # Generate your own unique keys: npx web-push generate-vapid-keys
      VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY:-BPT864f6ph9vkIXmyWJFsehe-Bb9iul4IiNoRN3To0UrixxFKKKsKGM4FUBF_vtjSAoFWxBDY9-4pdCCIMJwz7o}"
      VAPID_PRIVATE_KEY: "${VAPID_PRIVATE_KEY:-xJQ5l1xcpN79nKn5x1ufvuo0kGIuWGF5bPQDuiJKwlk}"

      # VAPID Subject (opcional) - identificação do servidor de push
      # Em produção, use: VAPID_SUBJECT: "https://seusite.com" ou "mailto:contato@seusite.com"
      # Se não definido, usa PUBLIC_URL (se for https://) ou fallback para mailto:
      # VAPID_SUBJECT: "mailto:admin@example.com"

    ports:
      - 8055:8055

    volumes:
      - ./dist/app.js:/directus/extensions/directus-extension-push-notification/dist/app.js:ro
      - ./dist/api.js:/directus/extensions/directus-extension-push-notification/dist/api.js:ro
      - ./package.json:/directus/extensions/directus-extension-push-notification/package.json:ro
      - ./dist/directus-state.json:/directus/extensions/directus-extension-push-notification/dist/directus-state.json:ro
      - ./dist/service-worker.js:/directus/extensions/directus-extension-push-notification/dist/service-worker.js:ro

    tmpfs:
      - /directus/uploads:rw,noexec,nosuid,size=64M,mode=777
      - /tmp/data:rw,size=64M,mode=777

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://0.0.0.0:8055/server/health",
        ]
      interval: 5s
      timeout: 5s
      retries: 40
      start_period: 120s

    restart: unless-stopped
